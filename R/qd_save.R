#' @title Save graph objects
#'
#' @description Export high-quality, scalable graphics for both print and online.
#'
#' @param graph Either a DiagrammeR graph object or a diagram generated by
#'   [DiagrammeR::render_graph()].
#' @param filename String for filename. Defaults to `NULL`.
#' @param filetype One of "png", "eps", "pdf", or "svg". Defaults to "pdf".
#' @param embed Defaults to `FALSE`. Automatically set to `TRUE` by [qd_embed()].
#' @param ... Pass arguments to [DiagrammeR::render_graph()], e.g., width and height
#'   (pixels) for .png files.
#'
#' @describeIn qd_save
#'
#' @export
qd_save <- function(graph, filename = NULL, filetype = "pdf", embed = FALSE, ...) {

  # File Format Match Table -----------------------------------------------
  fmt_opts <- c("png" = "rsvg::rsvg_png",
                "eps" = "rsvg::rsvg_ps",
                "pdf" = "rsvg::rsvg_pdf",
                "svg" = "rsvg::rsvg_svg")

  # Checks ----------------------------------------------------------------

  ## check for valid filetype
  if (!filetype %in% names(fmt_opts)) {
    stop(paste("Filetype not supported. Choose one of:",
               paste0(names(fmt_opts), collapse = ", ")))
  }

  ## check for filename
  if (is.null(filename)) {
    stop("Must specify the 'filename' option.")
  }


  # Graph Object ----------------------------------------------------------

  ## detect whether 'graph' = graph object or pre-rendered graph
  if (class(graph)[1] == "dgr_graph") {
    rendered_graph <- DiagrammeR::render_graph(graph, ...)
  } else if (class(graph)[1] == "grViz") {
    rendered_graph <- graph
  }

  # File Save -------------------------------------------------------------
  file_fmt <- match.arg(filetype, names(fmt_opts))
  raw_img <- charToRaw(DiagrammeRsvg::export_svg(rendered_graph))

  ## generate filename/path and make visible to qd_embed()
  fname <- paste(filename, file_fmt, sep = ".")
  if (embed) assign("fname", fname, envir = parent.frame())

  ## matches and calls rsvg_pdf(), rsvg_ps(), rsvg_eps(), or rsvg_svg
  out <- do.call(fmt_opts[[file_fmt]], list(raw_img, file = fname))
  return(out)
}



#' @title Embed diagrams in RMarkdown
#' @description A wrapper around [qd_save()] meant for use within R code chunks in
#'   RMarkdown documents.
#'
#' @param ... Pass arguments to [qd_save()].
#'
#' @export
qd_embed <- function(...) {
  qd_save(..., embed = TRUE)
  knitr::include_graphics(fname) # fname from qdsave()
}
